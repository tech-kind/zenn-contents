---
title: "ROS2 Foxyã§rqt_bagã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹"
emoji: "ğŸ€"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ros2"]
published: true
---

# ã¯ã˜ã‚ã«

ROSã‚’é–‹ç™ºã™ã‚‹ã†ãˆã§ä¾¿åˆ©ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦RQtã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚
RQtã¯Qtã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸGUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€æ§˜ã€…ãªãƒ„ãƒ¼ãƒ«ã‚„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å½¢ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚
è©³ç´°ã¯ROS2ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

http://docs.ros.org/en/foxy/Concepts/About-RQt.html

ROS1[^1]ã§ã¯ã€20ä»¥ä¸Šã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒä½œæˆã•ã‚Œã€ã“ã‚Œã‚‰ã¯ROS2ã¸ã¨ç§»æ¤ã•ã‚Œã¦ã„ã‚‹æ®µéšã§ã™ã€‚
ãªã®ã§ã€ROS1ã®ã¨ãã«ä½¿ãˆã¦ã„ãŸã®ã«ã€ROS2ã§ã¯ã¾ã ä½¿ãˆãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ã‚ã£ãŸã‚Šã—ã¾ã™ã€‚

[^1]: ROS2ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã«æ˜ç¤ºçš„ã«1ã‚’ã¤ã‘ã¦ã€ŒROS1ã€ã¨è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

ãã®å†…ã®ã²ã¨ã¤ãŒ`rqt_bag`ã«ãªã‚Šã¾ã™ã€‚
`rqt_bag`ã¯ROS2 Foxyã§ã¯æ¨™æº–ã§ä½¿ç”¨ã§ããªã„ãƒ„ãƒ¼ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚

ROS1/ROS2ã«ã¯rosbagã¨å‘¼ã°ã‚Œã‚‹æµã‚Œã‚‹ãƒˆãƒ”ãƒƒã‚¯ã‚’ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚‹ã®ã§ã™ãŒã€`rqt_bag`ã¯ä¿å­˜ã—ãŸrosbagã‚’å¯è¦–åŒ–ã—ã¦ã©ã®ãƒˆãƒ”ãƒƒã‚¯ãŒã„ã¤æµã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

ROS1ã®ã¨ãã®`rqt_bag`ã®ä½¿ã„æ–¹ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

https://qiita.com/srs/items/f6e2c36996e34bcc4d73#%E6%A6%82%E8%A6%81

ä»Šå›ã¯ã“ã®`rqt_bag`ã‚’ROS2 Foxyã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨ã„ã†å†…å®¹ã§ã™ã€‚

# å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

`rqt_bag`ã‚’ä½¿ç”¨ã™ã‚‹ã®ã«å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã‚’GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãã¾ã™ã€‚

å¿…è¦ãªãƒªãƒã‚¸ãƒˆãƒªã¯ä»¥ä¸‹ã®5ã¤ã§ã™ã€‚

| No. | ãƒªãƒã‚¸ãƒˆãƒªå | URL |
| ---- | ---- | ---- |
| 1 | rcl_interfaces | https://github.com/ros2/rcl_interfaces |
| 2 | test_interface_files | https://github.com/ros2/test_interface_files |
| 3 | pybind11_vendor | https://github.com/ros2/pybind11_vendor |
| 4 | rosbag2 | https://github.com/ros2/rosbag2 |
| 5 | rqt_bag | https://github.com/ros-visualization/rqt_bag |

ã‚‚ã¨ã‚‚ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹Foxyã®ç’°å¢ƒã¯ã„ã˜ã‚ŠãŸããªã„ã®ã§ã€ãƒã‚°ãƒ„ãƒ¼ãƒ«ç”¨ã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¸€ã¤ä½œæˆã—ã€ãã“ã«ä¸Šè¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã„ãã¾ã™ã€‚

``` bash
$ mkdir -p ~/bag_tool_ws/src
$ cd ~/bag_tool_ws/src
$ git clone https://github.com/ros2/rcl_interfaces.git -b foxy
$ git clone https://github.com/ros2/test_interface_files.git -b foxy
$ git clone https://github.com/ros2/pybind11_vendor.git -b foxy
$ git clone https://github.com/ros2/rosbag2.git -b emersonknapp/futurize-foxy
$ git clone https://github.com/ros-visualization/rqt_bag.git -b ros2
```

::: message

ãƒã‚¤ãƒ³ãƒˆã¯rosbag2ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹éš›ã«ã€ãƒ–ãƒ©ãƒ³ãƒã‚’`emersonknapp/futurize-foxy`ã«ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚
ãŸã ã—ã€ç¾åœ¨ã‚‚é–‹ç™ºä¸­ã®ãƒ–ãƒ©ãƒ³ãƒã§å¾Œè¿°ã™ã‚‹ã‚ˆã†ã«ä¸€éƒ¨ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‰ãªã„ãªã©ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€è‡ªå·±è²¬ä»»ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€ã“ã®`emersonknapp/futurize-foxy`ã¯å°†æ¥çš„ã«`foxy-future`ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹äºˆå®šã§ã™[^2]ã€‚ãã®éš›ã¯`foxy-future`ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

[^2]: https://github.com/ros2/rosbag2/pull/687
:::

# ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã‚‹

å¿…è¦ãªã‚‚ã®ã¯ç”¨æ„ã§ããŸã®ã§ã€ãƒã‚°ãƒ„ãƒ¼ãƒ«ç”¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã”ã¨ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

``` bash
$ cd ~/bag_tool_ws
$ colcon build --symlink-install
```

ã‚ã‚Œã€ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‰ãªã„ã ã¨ã€‚ã€‚ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

::: details ã‚¨ãƒ©ãƒ¼å†…å®¹

```
--- stderr: rosbag2_transport
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:42,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_reader.hpp:28:8: error: â€˜void MockSequentialReader::open(const rosbag2_storage::StorageOptions&, const rosbag2_cpp::ConverterOptions&)â€™ marked â€˜overrideâ€™, but does not override
   28 |   void open(
      |        ^~~~
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:43,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_writer.hpp:28:8: error: â€˜void MockSequentialWriter::open(const rosbag2_storage::StorageOptions&, const rosbag2_cpp::ConverterOptions&)â€™ marked â€˜overrideâ€™, but does not override
   28 |   void open(
      |        ^~~~
In file included from /usr/include/c++/9/memory:80,
                 from /opt/ros/foxy/src/gmock_vendor/include/gmock/gmock-actions.h:45,
                 from /opt/ros/foxy/src/gmock_vendor/include/gmock/gmock.h:59,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:15:
/usr/include/c++/9/bits/unique_ptr.h: In instantiation of â€˜typename std::_MakeUniq<_Tp>::__single_object std::make_unique(_Args&& ...) [with _Tp = MockSequentialReader; _Args = {}; typename std::_MakeUniq<_Tp>::__single_object = std::unique_ptr<MockSequentialReader, std::default_delete<MockSequentialReader> >]â€™:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:62:90:   required from here
/usr/include/c++/9/bits/unique_ptr.h:857:30: error: invalid new-expression of abstract class type â€˜MockSequentialReaderâ€™
  857 |     { return unique_ptr<_Tp>(new _Tp(std::forward<_Args>(__args)...)); }
      |                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:42,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_reader.hpp:25:7: note:   because the following virtual functions are pure within â€˜MockSequentialReaderâ€™:
   25 | class MockSequentialReader : public rosbag2_cpp::reader_interfaces::BaseReaderInterface
      |       ^~~~~~~~~~~~~~~~~~~~
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_reader.hpp:23,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:42,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/opt/ros/foxy/include/rosbag2_cpp/reader_interfaces/base_reader_interface.hpp:40:16: note: 	â€˜virtual void rosbag2_cpp::reader_interfaces::BaseReaderInterface::open(const rosbag2_cpp::StorageOptions&, const rosbag2_cpp::ConverterOptions&)â€™
   40 |   virtual void open(
      |                ^~~~
In file included from /usr/include/c++/9/memory:80,
                 from /opt/ros/foxy/src/gmock_vendor/include/gmock/gmock-actions.h:45,
                 from /opt/ros/foxy/src/gmock_vendor/include/gmock/gmock.h:59,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:15:
/usr/include/c++/9/bits/unique_ptr.h: In instantiation of â€˜typename std::_MakeUniq<_Tp>::__single_object std::make_unique(_Args&& ...) [with _Tp = MockSequentialWriter; _Args = {}; typename std::_MakeUniq<_Tp>::__single_object = std::unique_ptr<MockSequentialWriter, std::default_delete<MockSequentialWriter> >]â€™:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:63:90:   required from here
/usr/include/c++/9/bits/unique_ptr.h:857:30: error: invalid new-expression of abstract class type â€˜MockSequentialWriterâ€™
  857 |     { return unique_ptr<_Tp>(new _Tp(std::forward<_Args>(__args)...)); }
      |                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:43,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_writer.hpp:25:7: note:   because the following virtual functions are pure within â€˜MockSequentialWriterâ€™:
   25 | class MockSequentialWriter : public rosbag2_cpp::writer_interfaces::BaseWriterInterface
      |       ^~~~~~~~~~~~~~~~~~~~
In file included from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/mock_sequential_writer.hpp:23,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/rosbag2_transport_test_fixture.hpp:43,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/record_integration_fixture.hpp:31,
                 from /home/ubuntu/shared_dir/ros2_bag_ws/src/rosbag2/rosbag2_transport/test/rosbag2_transport/test_record_regex.cpp:24:
/opt/ros/foxy/include/rosbag2_cpp/writer_interfaces/base_writer_interface.hpp:37:16: note: 	â€˜virtual void rosbag2_cpp::writer_interfaces::BaseWriterInterface::open(const rosbag2_cpp::StorageOptions&, const rosbag2_cpp::ConverterOptions&)â€™
   37 |   virtual void open(
      |                ^~~~
make[2]: *** [CMakeFiles/test_record_regex__rmw_fastrtps_cpp.dir/build.make:63: CMakeFiles/test_record_regex__rmw_fastrtps_cpp.dir/test/rosbag2_transport/test_record_regex.cpp.o] Error 1
make[1]: *** [CMakeFiles/Makefile2:512: CMakeFiles/test_record_regex__rmw_fastrtps_cpp.dir/all] Error 2
make: *** [Makefile:141: all] Error 2
---
Failed   <<< rosbag2_transport [5.92s, exited with code 2]
```

:::

ã©ã†ã‚‚`rosbag2_transport`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
ã—ã‹ã—ã€ã‚ˆãè¦‹ã‚‹ã¨ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¦ã„ã‚‹ã®ã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãªã®ã§ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰é€šã•ãªã‘ã‚Œã°ã„ã‘ã‚‹ã˜ã‚ƒã‚“?ã¨ã„ã†å®‰ç›´ãªãƒãƒªã§`rosbag2_transport`ã®`CMakeLists.txt`ã‹ã‚‰ãƒ†ã‚¹ãƒˆã«è©²å½“ã™ã‚‹éƒ¨åˆ†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚ç¬‘

::: details å¤‰æ›´å‰

``` cmake:CMakeLists.txt
cmake_minimum_required(VERSION 3.5)
project(rosbag2_transport)

# Default to C99
if(NOT CMAKE_C_STANDARD)
  set(CMAKE_C_STANDARD 99)
endif()

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# Windows supplies macros for min and max by default. We should only use min and max from stl
if(WIN32)
  add_definitions(-DNOMINMAX)
endif()

find_package(ament_cmake REQUIRED)
find_package(ament_cmake_ros REQUIRED)
find_package(rcl REQUIRED)
find_package(rclcpp REQUIRED)
find_package(rcutils REQUIRED)
find_package(rmw REQUIRED)
find_package(rosbag2_compression REQUIRED)
find_package(rosbag2_cpp REQUIRED)
find_package(rosbag2_interfaces REQUIRED)
find_package(rosbag2_storage REQUIRED)
find_package(rmw_implementation_cmake REQUIRED)
find_package(shared_queues_vendor REQUIRED)
find_package(yaml_cpp_vendor REQUIRED)

add_library(${PROJECT_NAME} SHARED
  src/rosbag2_transport/player.cpp
  src/rosbag2_transport/qos.cpp
  src/rosbag2_transport/recorder.cpp
  src/rosbag2_transport/topic_filter.cpp)
target_include_directories(${PROJECT_NAME} PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>)
ament_target_dependencies(${PROJECT_NAME}
  rcl
  rclcpp
  rcutils
  rmw
  rosbag2_compression
  rosbag2_cpp
  rosbag2_interfaces
  rosbag2_storage
  shared_queues_vendor
  yaml_cpp_vendor
)

# Causes the visibility macros to use dllexport rather than dllimport,
# which is appropriate when building the dll but not consuming it.
target_compile_definitions(${PROJECT_NAME} PRIVATE "ROSBAG2_TRANSPORT_BUILDING_LIBRARY")

install(
  DIRECTORY include/
  DESTINATION include
)
install(
  TARGETS ${PROJECT_NAME}
  EXPORT export_${PROJECT_NAME}
  ARCHIVE DESTINATION lib
  LIBRARY DESTINATION lib
  RUNTIME DESTINATION bin
)

ament_export_include_directories(include)
ament_export_libraries(${PROJECT_NAME})
ament_export_targets(export_${PROJECT_NAME})
ament_export_dependencies(
  rosbag2_cpp
  rosbag2_compression
  rosbag2_interfaces
  shared_queues_vendor
  yaml_cpp_vendor)

function(create_tests_for_rmw_implementation)
  # disable the following tests for connext
  # due to slower discovery of nodes
  set(SKIP_TEST "")
  if(${rmw_implementation} MATCHES "rmw_connext(.*)")
    set(SKIP_TEST "SKIP_TEST")
  endif()

  rosbag2_transport_add_gmock(test_play
    src/rosbag2_transport/qos.cpp
    test/rosbag2_transport/test_play.cpp
    INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_play_loop
    test/rosbag2_transport/test_play_loop.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_play_publish_clock
    test/rosbag2_transport/test_play_publish_clock.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_play_timing
    test/rosbag2_transport/test_play_timing.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common)

  rosbag2_transport_add_gmock(test_play_services
    test/rosbag2_transport/test_play_services.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common)

  rosbag2_transport_add_gmock(test_play_topic_remap
    test/rosbag2_transport/test_play_topic_remap.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_play_next
      test/rosbag2_transport/test_play_next.cpp
      INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
      LINK_LIBS rosbag2_transport
      AMENT_DEPS test_msgs rosbag2_test_common)

  rosbag2_transport_add_gmock(test_qos
    src/rosbag2_transport/qos.cpp
    test/rosbag2_transport/test_qos.cpp
    INCLUDE_DIRS
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
    AMENT_DEPS rosbag2_test_common yaml_cpp_vendor)

  rosbag2_transport_add_gmock(test_record
    test/rosbag2_transport/test_record.cpp
    INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_record_all
    test/rosbag2_transport/test_record_all.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common)

  rosbag2_transport_add_gmock(test_record_all_no_discovery
    test/rosbag2_transport/test_record_all_no_discovery.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common)

  rosbag2_transport_add_gmock(test_record_regex
    test/rosbag2_transport/test_record_regex.cpp
    LINK_LIBS rosbag2_transport
    AMENT_DEPS test_msgs rosbag2_test_common
    ${SKIP_TEST})

  rosbag2_transport_add_gmock(test_topic_filter
    test/rosbag2_transport/test_topic_filter.cpp
    INCLUDE_DIRS
      $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
    LINK_LIBS rosbag2_transport)
endfunction()

if(BUILD_TESTING)
  find_package(ament_cmake_gmock REQUIRED)
  find_package(ament_index_cpp REQUIRED)
  find_package(ament_lint_auto REQUIRED)
  find_package(test_msgs REQUIRED)
  find_package(rosbag2_test_common REQUIRED)
  include(cmake/rosbag2_transport_add_gmock.cmake)
  ament_lint_auto_find_test_dependencies()
  call_for_each_rmw_implementation(create_tests_for_rmw_implementation)
endif()

ament_package()
```

:::

::: details å¤‰æ›´å¾Œ

``` cmake:CMakeLists.txt
cmake_minimum_required(VERSION 3.5)
project(rosbag2_transport)

# Default to C99
if(NOT CMAKE_C_STANDARD)
  set(CMAKE_C_STANDARD 99)
endif()

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# Windows supplies macros for min and max by default. We should only use min and max from stl
if(WIN32)
  add_definitions(-DNOMINMAX)
endif()

find_package(ament_cmake REQUIRED)
find_package(ament_cmake_ros REQUIRED)
find_package(rcl REQUIRED)
find_package(rclcpp REQUIRED)
find_package(rcutils REQUIRED)
find_package(rmw REQUIRED)
find_package(rosbag2_compression REQUIRED)
find_package(rosbag2_cpp REQUIRED)
find_package(rosbag2_interfaces REQUIRED)
find_package(rosbag2_storage REQUIRED)
find_package(rmw_implementation_cmake REQUIRED)
find_package(shared_queues_vendor REQUIRED)
find_package(yaml_cpp_vendor REQUIRED)

add_library(${PROJECT_NAME} SHARED
  src/rosbag2_transport/player.cpp
  src/rosbag2_transport/qos.cpp
  src/rosbag2_transport/recorder.cpp
  src/rosbag2_transport/topic_filter.cpp)
target_include_directories(${PROJECT_NAME} PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>)
ament_target_dependencies(${PROJECT_NAME}
  rcl
  rclcpp
  rcutils
  rmw
  rosbag2_compression
  rosbag2_cpp
  rosbag2_interfaces
  rosbag2_storage
  shared_queues_vendor
  yaml_cpp_vendor
)

# Causes the visibility macros to use dllexport rather than dllimport,
# which is appropriate when building the dll but not consuming it.
target_compile_definitions(${PROJECT_NAME} PRIVATE "ROSBAG2_TRANSPORT_BUILDING_LIBRARY")

install(
  DIRECTORY include/
  DESTINATION include
)
install(
  TARGETS ${PROJECT_NAME}
  EXPORT export_${PROJECT_NAME}
  ARCHIVE DESTINATION lib
  LIBRARY DESTINATION lib
  RUNTIME DESTINATION bin
)

ament_export_include_directories(include)
ament_export_libraries(${PROJECT_NAME})
ament_export_targets(export_${PROJECT_NAME})
ament_export_dependencies(
  rosbag2_cpp
  rosbag2_compression
  rosbag2_interfaces
  shared_queues_vendor
  yaml_cpp_vendor)

# function(create_tests_for_rmw_implementation)
#   # disable the following tests for connext
#   # due to slower discovery of nodes
#   set(SKIP_TEST "")
#   if(${rmw_implementation} MATCHES "rmw_connext(.*)")
#     set(SKIP_TEST "SKIP_TEST")
#   endif()
# 
#   rosbag2_transport_add_gmock(test_play
#     src/rosbag2_transport/qos.cpp
#     test/rosbag2_transport/test_play.cpp
#     INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_play_loop
#     test/rosbag2_transport/test_play_loop.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_play_publish_clock
#     test/rosbag2_transport/test_play_publish_clock.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_play_timing
#     test/rosbag2_transport/test_play_timing.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common)
# 
#   rosbag2_transport_add_gmock(test_play_services
#     test/rosbag2_transport/test_play_services.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common)
# 
#   rosbag2_transport_add_gmock(test_play_topic_remap
#     test/rosbag2_transport/test_play_topic_remap.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_play_next
#       test/rosbag2_transport/test_play_next.cpp
#       INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
#       LINK_LIBS rosbag2_transport
#       AMENT_DEPS test_msgs rosbag2_test_common)
# 
#   rosbag2_transport_add_gmock(test_qos
#     src/rosbag2_transport/qos.cpp
#     test/rosbag2_transport/test_qos.cpp
#     INCLUDE_DIRS
#       $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
#       $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
#     AMENT_DEPS rosbag2_test_common yaml_cpp_vendor)
# 
#   rosbag2_transport_add_gmock(test_record
#     test/rosbag2_transport/test_record.cpp
#     INCLUDE_DIRS $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_record_all
#     test/rosbag2_transport/test_record_all.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common)
# 
#   rosbag2_transport_add_gmock(test_record_all_no_discovery
#     test/rosbag2_transport/test_record_all_no_discovery.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common)
# 
#   rosbag2_transport_add_gmock(test_record_regex
#     test/rosbag2_transport/test_record_regex.cpp
#     LINK_LIBS rosbag2_transport
#     AMENT_DEPS test_msgs rosbag2_test_common
#     ${SKIP_TEST})
# 
#   rosbag2_transport_add_gmock(test_topic_filter
#     test/rosbag2_transport/test_topic_filter.cpp
#     INCLUDE_DIRS
#       $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src/rosbag2_transport>
#     LINK_LIBS rosbag2_transport)
# endfunction()
# 
# if(BUILD_TESTING)
#   find_package(ament_cmake_gmock REQUIRED)
#   find_package(ament_index_cpp REQUIRED)
#   find_package(ament_lint_auto REQUIRED)
#   find_package(test_msgs REQUIRED)
#   find_package(rosbag2_test_common REQUIRED)
#   include(cmake/rosbag2_transport_add_gmock.cmake)
#   ament_lint_auto_find_test_dependencies()
#   call_for_each_rmw_implementation(create_tests_for_rmw_implementation)
# endif()

ament_package()
```

:::

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€`function(create_tests_for_rmw_implementation)`ã¨`if(BUILD_TESTING)`ã®ä¸­èº«ã‚’ã¾ã‚‹ã£ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã«ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
ã“ã‚Œã§ã‚‚ã†ä¸€åº¦ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨....ã‚„ã£ãŸãƒ¼ï¼ãƒ“ãƒ«ãƒ‰é€šã‚Šã¾ã—ãŸã€‚
ã‚ã¨ã¯ã€ä½¿ã„ãŸã„ã¨ãã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’`source`ã™ã‚Œã°å¤§ä¸ˆå¤«ã§ã™ã€‚

``` bash
$ source ~/bag_tool_ws/install/setup.bash
```

# ä½¿ã£ã¦ã¿ã‚‹

`rqt_bag`ã‚’èµ·å‹•ã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

``` bash
$ ros2 run rqt_bag rqt_bag
```

ã‚ˆã—ã€ç”»é¢ãŒé–‹ã„ãŸãï¼ã ã‘ã©ã€ä½•ã‹ãŠã‹ã—ã„ã‚ˆã†ãª....

![](https://storage.googleapis.com/zenn-user-upload/9844f1a49f2e79234e8485b3.png)

ã‚ã‚Œã€ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚ã€‚ã€‚
ã„ã‚„ã€å¿ƒã®ç›®ã§è¦‹ã‚Œã°å¤§ä¸ˆå¤«ã€‚ãã†ã‹ã€å·¦ã‹ã‚‰äºŒã¤ç›®ãŒrosbagã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã™ã‚‹ãƒœã‚¿ãƒ³ã‹ã€‚
ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã¿ã‚ˆã†ã€‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ã„ãŸãªã€‚

![](https://storage.googleapis.com/zenn-user-upload/87591d7d277251cf982f79b9.png)

ã“ã‚Œã§ã€äºˆã‚ä¿å­˜ã—ã¦ãŠã„ãŸã€rosbagã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ã¿ã‚ˆã†ï¼

![](https://storage.googleapis.com/zenn-user-upload/48e6c9fa2843a1ccd33ceef6.png)

ãŠãŠãƒ¼ã€ã—ã£ã‹ã‚Šè¡¨ç¤ºã•ã‚Œã¦ã‚‹ï¼å€¤ã‚‚ç¢ºèªã§ãã‚‹ãï¼

ã¨ã„ã†ã“ã¨ã§ã€ä½¿ãˆã‚‹ï¼ˆ?ï¼‰ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ç¬‘

::: message

è£œè¶³ã§ã™ãŒã€ROS2ã§rosbagã‚’ä¿å­˜ã™ã‚‹ã«ã¯

``` bash
$ ros2 bag record {topic_name}
```

ã¨ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸãƒˆãƒ”ãƒƒã‚¯ãŒæµã‚Œã‚‹ãŸã³ã«ã€rosbagã¨ã—ã¦è¨˜éŒ²ãŒæ®‹ã‚Šã¾ã™ï¼ˆã‚‚ã¡ã‚ã‚“ã€è¤‡æ•°ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ã¾ã¨ã‚ã¦ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼‰ã€‚
æœ€çµ‚çš„ã«ã€rosbagã¯ãƒˆãƒ”ãƒƒã‚¯ã®åŸºæœ¬çš„ãªæƒ…å ±ã‚’ã¾ã¨ã‚ãŸ`metadata.yaml`ã¨å®Ÿéš›ã«é€ä¿¡ã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯å†…éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆ`*****.db3`ï¼‰ã¨ã‚’ã¾ã¨ã‚ãŸä¸€ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
`rqt_bag`ã§rosbagã‚’è¡¨ç¤ºã™ã‚‹éš›ã«ã¯`metadata.yaml`ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã©ã¡ã‚‰ã‚‚å¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ä¸Šè¨˜ã§rosbagã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ã„ã¾ã—ãŸãŒã€ãƒ•ã‚©ãƒ«ãƒ€å†…ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒæƒã£ã¦ã„ãªã„ã¨ã†ã¾ãrosbagãŒè¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ã€ã”æ³¨æ„ãã ã•ã„ã€‚

:::

# ã¾ã¨ã‚

`rqt_bag`ãŒé‡å®ã™ã‚‹ã®ã¯ã€ãŠãã‚‰ããƒã‚°ã®è§£æãŒå¿…è¦ã«ãªã£ãŸã¨ãã ã¨æ€ã„ã¾ã™ã€‚
å¤§è¦æ¨¡ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚‹ã¨ã€æ§˜ã€…ãªãƒˆãƒ”ãƒƒã‚¯ãŒé€å—ä¿¡ã•ã‚Œã€ãã‚Œãã‚Œã®ãƒˆãƒ”ãƒƒã‚¯ãŒã„ã¤é€ä¿¡ã•ã‚ŒãŸã®ã‹å‰å¾Œé–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ã®ãŒé›£ã—ããªã£ãŸã‚Šã™ã‚‹ã®ã§ã€ã“ã†ã„ã£ãŸãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦å¯è¦–åŒ–ã§ãã‚‹ã®ã¯ã¨ã¦ã‚‚å½¹ã«ç«‹ã¡ã¾ã™ã€‚
çš†ã•ã‚“ã‚‚ãœã²ãƒã‚°ã®è§£æã«`rqt_bag`ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã­ï¼
